<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Logic Prototype</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        h1 { font-weight: 300; color: #555; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        
        #controls-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            color: #888;
        }
        .text-btn {
            cursor: pointer;
            transition: color 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0.4;
        }
        .text-btn:hover { color: #333; opacity: 1; }
        
        #grid {
            display: grid;
            grid-gap: 10px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 95vw;
            overflow: auto;
        }
        .cell {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            background-color: #e9ecef;
            border: 4px solid transparent;
            user-select: none;
            box-sizing: border-box;
            background-clip: padding-box;
            padding: 4px;
        }
        .cell.active {
            background-color: #4dabf7 !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(77, 171, 247, 0.4);
            background-clip: content-box;
        }
        .cell.correct {
            border-color: #40c057;
            box-shadow: inset 0 0 10px rgba(64, 192, 87, 0.5);
        }
        .cell.too-many {
            border-color: #fa5252;
            box-shadow: inset 0 0 10px rgba(250, 82, 82, 0.5);
            color: #fa5252;
        }
        #status {
            margin-top: 20px;
            font-weight: 500;
        }
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-item:hover { transform: translateY(-5px); }
        .menu-item.completed .menu-box {
            background-color: #ebfbee;
            border-color: #40c057;
            color: #2b8a3e;
        }
        .menu-item.completed .menu-box::after {
            content: "✓";
            position: absolute;
            top: -5px;
            right: -5px;
            background: #40c057;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .menu-item.in-progress .menu-box {
            border-color: #4dabf7;
            border-style: dashed;
        }
        .menu-box {
            position: relative;
            width: 60px;
            height: 60px;
            background: #fff;
            border: 4px solid #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 8px;
        }
        .menu-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 600;
            text-align: center;
            max-width: 80px;
        }
        #level-menu {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 800px;
        }
        .cat-title {
            width: 100%;
            text-align: center;
            margin-top: 30px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        #settings-toggle { 
            cursor: pointer; 
            font-size: 20px; 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            opacity: 0.4; 
            transition: opacity 0.2s; 
            user-select: none;
            color: #333;
            filter: grayscale(100%);
        }
        #settings-toggle:hover { opacity: 1; }
        
        #settings-panel, #how-to-play-panel {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 100;
            width: 240px;
        }
        #how-to-play-panel { width: 300px; left: 50%; transform: translateX(-50%); top: 100px; }
        #how-to-play-panel h3 { margin-top: 0; }
        #how-to-play-panel p { font-size: 14px; line-height: 1.5; color: #555; }
        
        .section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        button {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .btn-primary { background: #4dabf7; color: white; }
        .btn-danger { background: #fa5252; color: white; }
        .btn-ghost { background: #e9ecef; color: #333; }
    </style>
</head>
<body>
    <h1 id="main-header">Zen Logic</h1>

    <div id="controls-row">
        <span id="back-btn" class="text-btn" onclick="showMenu()" style="display: none;">← Back</span>
        <span id="undo-btn" class="text-btn" onclick="undoMove()" style="display: none;">↩ Undo</span>
        <span id="reset-btn" class="text-btn" onclick="resetGame()" style="display: none;">↺ Reset</span>
        <span id="help-btn" class="text-btn" onclick="toggleHelp()">? Rules</span>
    </div>
    
    <div id="settings-toggle" onclick="toggleSettings()" title="Settings">⚙</div>

    <div id="settings-panel">
        <h3>Settings</h3>
        <div class="section">
            <div style="font-size: 12px; color: #888; margin-bottom: 8px;">DATA MANAGEMENT</div>
            <button class="btn-primary" onclick="exportData()">Export Progress</button>
            <button class="btn-primary" onclick="document.getElementById('import-file').click()">Import Progress</button>
            <input type="file" id="import-file" style="display: none" accept=".json" onchange="importData(event)">
        </div>
        <div class="section">
            <button class="btn-danger" onclick="clearAllProgress()">Clear All Progress</button>
            <button class="btn-ghost" onclick="toggleSettings()">Close</button>
        </div>
    </div>

    <div id="how-to-play-panel">
        <h3>How to Play</h3>
        <p>The goal is to satisfy every number on the grid.</p>
        <p><strong>The Numbers:</strong> Each number tells you exactly how many <strong>blue</strong> tiles must be in its <strong>presence</strong>.</p>
        <p><strong>The Colors:</strong> Click a tile to change its state.
            <ul>
                <li><span style="color:#40c057; font-weight:bold;">Green Border:</span> Correct presence.</li>
                <li><span style="color:#fa5252; font-weight:bold;">Red Border:</span> Presence is too high.</li>
                <li><strong>Grey Border:</strong> Need more presence.</li>
            </ul>
        </p>
        <button class="btn-primary" onclick="toggleHelp()">Got it!</button>
    </div>
    
    <div id="level-menu"></div>

    <div id="game-view" style="display: none; flex-direction: column; align-items: center;">
        <div id="grid"></div>
        <div id="status">Solve the pattern!</div>
        <div id="level-id-display" onclick="copyUID()" style="cursor: pointer; font-size: 10px; color: #ccc; margin-top: 10px; font-family: monospace;" title="Click to copy UID"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            const isHidden = window.getComputedStyle(panel).display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            if (isHidden) document.getElementById('how-to-play-panel').style.display = 'none';
        }

        function toggleHelp() {
            const panel = document.getElementById('how-to-play-panel');
            const isHidden = window.getComputedStyle(panel).display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            if (isHidden) document.getElementById('settings-panel').style.display = 'none';
        }

        function clearAllProgress() {
            if (confirm("Clear all progress? This cannot be undone.")) {
                localStorage.removeItem('zen_completed');
                localStorage.removeItem('zen_in_progress');
                toggleSettings();
                showMenu();
            }
        }

        function exportData() {
            const data = {
                completed: getCompleted(),
                inProgress: JSON.parse(localStorage.getItem('zen_in_progress') || '{}'),
                version: 1,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zen_logic_save_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.completed) localStorage.setItem('zen_completed', JSON.stringify(data.completed));
                    if (data.inProgress) localStorage.setItem('zen_in_progress', JSON.stringify(data.inProgress));
                    alert("Progress imported successfully!");
                    location.reload();
                } catch (err) {
                    alert("Failed to import data.");
                }
            };
            reader.readAsText(file);
        }

        let levelManifest = [];
        const levelsCache = {
            "tutorial": { "id": "tutorial", "title": "Welcome", "display": "3x3", "width": 3, "height": 3, "clues": [[2, 2, 1], [2, 2, 2], [3, 2, 2]], "difficulty": "easy" }
        };

        let currentLevel = null;
        let state = [];
        let history = [];

        async function fetchManifest() {
            try {
                const response = await fetch('manifest.json');
                if (response.ok) levelManifest = await response.json();
            } catch (e) { console.error("Could not load manifest", e); }
        }

        function getCompleted() {
            return JSON.parse(localStorage.getItem('zen_completed') || '[]');
        }

        function saveInProgress(id, state) {
            const hasActiveCells = state.some(row => row.some(cell => cell === 1));
            let inProgress = JSON.parse(localStorage.getItem('zen_in_progress') || '{}');
            if (hasActiveCells) inProgress[id] = state;
            else delete inProgress[id];
            localStorage.setItem('zen_in_progress', JSON.stringify(inProgress));
        }

        function getInProgress(id) {
            let inProgress = JSON.parse(localStorage.getItem('zen_in_progress') || '{}');
            return inProgress[id];
        }

        function clearInProgress(id) {
            let inProgress = JSON.parse(localStorage.getItem('zen_in_progress') || '{}');
            delete inProgress[id];
            localStorage.setItem('zen_in_progress', JSON.stringify(inProgress));
        }

        function markCompleted(id) {
            let completed = getCompleted();
            if (!completed.includes(id)) {
                completed.push(id);
                localStorage.setItem('zen_completed', JSON.stringify(completed));
            }
            clearInProgress(id);
        }

        function showMenu() {
            window.history.pushState({}, '', window.location.pathname);
            document.getElementById('main-header').innerText = "Zen Logic";
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('undo-btn').style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('level-menu').style.display = 'flex';
            document.getElementById('game-view').style.display = 'none';
            initMenu();
        }

        function initMenu() {
            const menuEl = document.getElementById('level-menu');
            if (!menuEl) return;
            menuEl.innerHTML = '';
            const completed = getCompleted();
            const inProgress = JSON.parse(localStorage.getItem('zen_in_progress') || '{}');

            const categories = [
                { name: 'Training (3x3)', filter: (l) => l.width === 3 },
                { name: 'Standard (5x5)', filter: (l) => l.width === 5 },
                { name: 'Deep Focus (10x10)', filter: (l) => l.width === 10 },
                { name: 'Zen Master (15x15)', filter: (l) => l.width === 15 }
            ];

            categories.forEach(cat => {
                const filtered = levelManifest.filter(cat.filter);
                const allInCat = cat.name.includes('3x3') ? [levelsCache.tutorial, ...filtered] : filtered;
                if (allInCat.length > 0) {
                    const header = document.createElement('h2');
                    header.className = 'cat-title';
                    header.innerText = cat.name;
                    menuEl.appendChild(header);
                    allInCat.forEach(level => {
                        const item = document.createElement('div');
                        item.className = 'menu-item';
                        if (completed.includes(level.id)) item.classList.add('completed');
                        else if (inProgress[level.id]) item.classList.add('in-progress');
                        item.onclick = () => loadLevel(level.id);
                        item.innerHTML = `
                            <div class="menu-box">${level.display || (level.width + 'x' + level.height)}</div>
                            <div class="menu-label">${level.title || level.name}</div>
                        `;
                        menuEl.appendChild(item);
                    });
                }
            });
        }

        async function loadLevel(key) {
            if (!key) return showMenu();
            let levelData = levelsCache[key];
            if (!levelData || !levelData.clues) {
                try {
                    const response = await fetch(`levels/${key}.json`);
                    if (response.ok) {
                        const fetched = await response.json();
                        levelData = { ...fetched, id: key, title: fetched.name || "Generated", display: fetched.display || `${fetched.width}x${fetched.height}` };
                        levelsCache[key] = levelData;
                    }
                } catch (e) { console.error(e); }
            }
            if (!levelData || !levelData.clues) return showMenu();
            currentLevel = levelData;
            document.getElementById('main-header').innerText = currentLevel.title;
            document.getElementById('back-btn').style.display = 'flex';
            document.getElementById('undo-btn').style.display = 'flex';
            document.getElementById('reset-btn').style.display = 'flex';
            const saved = getInProgress(key);
            state = saved ? saved : Array(currentLevel.height).fill().map(() => Array(currentLevel.width).fill(0));
            history = [];
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('level') !== key) window.history.pushState({}, '', `?level=${key}`);
            document.getElementById('level-menu').style.display = 'none';
            document.getElementById('game-view').style.display = 'flex';
            document.getElementById('level-id-display').innerText = `UID: ${key}`;
            document.getElementById('status').innerText = "Solve the pattern!";
            createGrid();
            updateUI();
        }

        function createGrid() {
            if (!currentLevel || !currentLevel.clues) return;
            const gridEl = document.getElementById('grid');
            const cellSize = currentLevel.width > 10 ? '35px' : '50px';
            const fontSize = currentLevel.width > 10 ? '14px' : '18px';
            const gap = currentLevel.width > 10 ? '5px' : '10px';
            gridEl.style.gridGap = gap;
            gridEl.style.gridTemplateColumns = `repeat(${currentLevel.width}, ${cellSize})`;
            gridEl.innerHTML = '';
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.width = cellSize;
                    cell.style.height = cellSize;
                    cell.style.fontSize = fontSize;
                    cell.id = `cell-${x}-${y}`;
                    cell.innerText = currentLevel.clues[y][x];
                    cell.onclick = () => toggleCell(x, y);
                    gridEl.appendChild(cell);
                }
            }
            checkWin(true);
        }

        function toggleCell(x, y) {
            history.push(JSON.stringify(state));
            if (history.length > 50) history.shift();
            state[y][x] = state[y][x] === 0 ? 1 : 0;
            saveInProgress(currentLevel.id, state);
            updateUI();
            checkWin();
        }

        function undoMove() {
            if (history.length === 0) return;
            state = JSON.parse(history.pop());
            saveInProgress(currentLevel.id, state);
            updateUI();
            checkWin();
        }

        function updateUI() {
            if (!currentLevel) return;
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    const cell = document.getElementById(`cell-${x}-${y}`);
                    if (!cell) continue;
                    if (state[y][x] === 1) cell.classList.add('active');
                    else cell.classList.remove('active');
                }
            }
        }

        function checkWin(silent = false) {
            if (!currentLevel) return;
            let solved = true;
            let totalActive = 0;
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    if (state[y][x] === 1) totalActive++;
                    let neighbors = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            let nx = x + dx, ny = y + dy;
                            if (nx >= 0 && nx < currentLevel.width && ny >= 0 && ny < currentLevel.height) {
                                if (state[ny][nx] === 1) neighbors++;
                            }
                        }
                    }
                    const cell = document.getElementById(`cell-${x}-${y}`);
                    if (!cell) continue;
                    if (neighbors === currentLevel.clues[y][x]) {
                        cell.classList.add('correct');
                        cell.classList.remove('too-many');
                    } else {
                        cell.classList.remove('correct');
                        if (neighbors > currentLevel.clues[y][x]) cell.classList.add('too-many');
                        else cell.classList.remove('too-many');
                        solved = false;
                    }
                }
            }
            if (solved && totalActive > 0) {
                if (!silent) {
                    const statusEl = document.getElementById('status');
                    if (statusEl.innerText !== "✨ Clarity Achieved!") {
                        statusEl.innerText = "✨ Clarity Achieved!";
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#4dabf7', '#40c057', '#fab005'] });
                    }
                }
                markCompleted(currentLevel.id);
            } else if (!silent) {
                document.getElementById('status').innerText = "Solve the pattern!";
            }
        }

        function resetGame() {
            if (!currentLevel) return;
            if (confirm("Reset this board?")) {
                history = [];
                state = Array(currentLevel.height).fill().map(() => Array(currentLevel.width).fill(0));
                clearInProgress(currentLevel.id);
                updateUI();
                checkWin();
            }
        }

        function copyUID() {
            const uidText = currentLevel.id;
            navigator.clipboard.writeText(uidText);
            const el = document.getElementById('level-id-display');
            const oldText = el.innerText;
            el.innerText = "Copied!";
            setTimeout(() => el.innerText = oldText, 1000);
        }

        async function boot() {
            await fetchManifest();
            window.onpopstate = () => {
                const urlParams = new URLSearchParams(window.location.search);
                loadLevel(urlParams.get('level'));
            };
            const urlParams = new URLSearchParams(window.location.search);
            const initialLevel = urlParams.get('level');
            if (initialLevel) loadLevel(initialLevel);
            else showMenu();
        }
        boot();
    </script>
</body>
</html>
