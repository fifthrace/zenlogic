<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxima 8 - Star Chart DEV</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b0e14">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <style>
        :root {
            --bg-color: #0b0e14;
            --panel-bg: #1a1b1e;
            --accent-blue: #4dabf7;
            --accent-yellow: #fab005;
            --accent-green: #40c057;
            --text-color: #ced4da;
            --grid-bg: #25262b;
            --cell-bg: #2c2e33;
            --border-color: #373a40;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        #viewport {
            position: relative;
            width: 100vw;
            height: 100vh;
            perspective: 1000px;
            overflow: hidden;
        }

        #universe {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
            transform-style: preserve-3d;
        }

        body.zoomed #universe {
            transform: scale(3) translate(var(--zoom-x, 0), var(--zoom-y, 0));
            opacity: 0.3;
            pointer-events: none;
        }

        .cluster {
            position: absolute;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            outline: none;
        }

        .cluster-core {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            filter: blur(10px);
            box-shadow: 0 0 30px 15px rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .cluster:hover .cluster-core { transform: scale(1.2); }

        .cluster-label {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .cluster-name {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 200;
            white-space: nowrap;
            background: rgba(0,0,0,0.4);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .cluster-status {
            font-size: 10px;
            font-family: monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            opacity: 0.9;
        }
        .status-scanning { color: #fd7e14; }
        .status-stable { color: #40c057; }

        /* Uniform Orbital Layout - Alpha in center, 6 in a ring */
        #sector-alpha    { top: 50%; left: 50%; transform: translate(-50%, -50%); } 
        #sector-crimson  { top: 20%; left: 50%; transform: translate(-50%, -50%); }
        #sector-azure    { top: 35%; left: 80%; transform: translate(-50%, -50%); }
        #sector-obsidian { top: 65%; left: 80%; transform: translate(-50%, -50%); }
        #sector-emerald  { top: 80%; left: 50%; transform: translate(-50%, -50%); }
        #sector-amber    { top: 65%; left: 20%; transform: translate(-50%, -50%); }
        #sector-indigo   { top: 35%; left: 20%; transform: translate(-50%, -50%); }

        @media (max-width: 600px) {
            #sector-alpha    { top: 50%; left: 50%; }
            #sector-crimson  { top: 25%; left: 50%; }
            #sector-azure    { top: 37%; left: 82%; }
            #sector-obsidian { top: 63%; left: 82%; }
            #sector-emerald  { top: 75%; left: 50%; }
            #sector-amber    { top: 63%; left: 18%; }
            #sector-indigo   { top: 37%; left: 18%; }
        }

        #system-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            pointer-events: none;
            background: radial-gradient(circle at center, rgba(26, 27, 30, 0.9) 0%, transparent 85%);
            opacity: 0;
            transform: scale(0.1);
            transition: opacity 0.8s ease, transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.zoomed #system-view { opacity: 1; transform: scale(1); pointer-events: all; }

        @keyframes corona {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.3; }
        }

        .central-sun {
            width: 100px; height: 100px; border-radius: 50%;
            position: relative; z-index: 2; pointer-events: none;
        }
        .sun-halo {
            position: absolute; width: 140px; height: 140px; border-radius: 50%;
            z-index: 1; animation: corona 4s infinite ease-in-out; filter: blur(10px);
        }

        #planet-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        .planet-wrapper {
            position: absolute; display: flex; flex-direction: column;
            align-items: center; cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .planet-wrapper:hover { transform: scale(1.1); z-index: 10; }

        .planet-sphere {
            border-radius: 50%;
            box-shadow: inset -8px -8px 15px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .planet-wrapper.completed .planet-sphere {
            box-shadow: inset -8px -8px 15px rgba(0,0,0,0.6), 0 0 0 2px var(--bg-color), 0 0 0 6px var(--accent-green);
        }
        .planet-wrapper.in-progress .planet-sphere {
            box-shadow: inset -8px -8px 15px rgba(0,0,0,0.6), 0 0 0 2px var(--bg-color), 0 0 0 3px #fd7e14;
        }

        .type-rocky { background: linear-gradient(135deg, #a8a095, #5d5751); }
        .type-water { background: linear-gradient(135deg, #4dabf7, #1864ab); }
        .type-gas { background: linear-gradient(135deg, #ff922b, #d9480f); }
        .type-ice { background: linear-gradient(135deg, #e7f5ff, #74c0fc); }

        .planet-label {
            margin-top: 8px; font-size: 9px; text-transform: uppercase;
            letter-spacing: 1px; font-weight: 600; background: rgba(0,0,0,0.6);
            padding: 2px 6px; border-radius: 4px; white-space: nowrap; color: #fff;
        }

        #game-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: none; flex-direction: column; align-items: center;
            padding: 40px 20px; box-sizing: border-box; overflow-y: auto;
        }

        #grid {
            display: grid; grid-gap: 4px;
            background: var(--grid-bg); padding: 8px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: fit-content; max-width: 98vw; margin: 0 auto; box-sizing: border-box;
        }
        .cell {
            --vw-unit: min(100vw, 500px);
            --paddings: 80px;
            --gaps: calc(4px * (var(--grid-width, 8) - 1));
            --cell-w: calc((var(--vw-unit) - var(--paddings) - var(--gaps)) / var(--grid-width, 8));
            
            width: min(var(--cell-w), 60px);
            height: min(var(--cell-w), 60px);
            aspect-ratio: 1 / 1; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; transition: all 0.2s ease;
            background-color: var(--cell-bg); border: 2px solid transparent;
            user-select: none; background-clip: padding-box; padding: 0px; color: var(--text-color);
            font-size: clamp(8px, 3.5vw, 18px);
        }
        .cell.active { background-color: var(--accent-blue) !important; color: white !important; box-shadow: 0 2px 8px rgba(77, 171, 247, 0.4); background-clip: content-box; }
        .cell.correct { border-color: var(--accent-green); box-shadow: inset 0 0 10px rgba(64, 192, 87, 0.5); }
        .cell.too-many { border-color: #fa5252; box-shadow: inset 0 0 10px rgba(250, 82, 82, 0.5); color: #fa5252; }
        .cell.override { background-color: var(--accent-yellow) !important; color: white !important; box-shadow: 0 0 15px rgba(250, 176, 5, 0.6); background-clip: padding-box !important; }

        .text-btn { cursor: pointer; opacity: 0.4; transition: opacity 0.2s; display: flex; align-items: center; gap: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 13px; }
        .text-btn:hover { opacity: 1; }
        
        #back-to-galaxy { position: absolute; top: 30px; left: 30px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; text-transform: uppercase; z-index: 100; font-size: 11px; letter-spacing: 1px; }
        #settings-toggle { cursor: pointer; font-size: 20px; position: absolute; top: 30px; right: 30px; opacity: 0.4; transition: opacity 0.2s; color: var(--text-color); z-index: 100; }

        @media (max-width: 600px) {
            .btn-text { display: none; }
            .text-btn { font-size: 24px; }
        }

        #next-btn.glow {
            opacity: 1;
            color: #fab005;
            text-shadow: 0 0 8px rgba(250, 176, 5, 0.6);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 5px rgba(250, 176, 5, 0.4); }
            50% { text-shadow: 0 0 20px rgba(250, 176, 5, 0.8); }
            100% { text-shadow: 0 0 5px rgba(250, 176, 5, 0.4); }
        }

        #settings-panel { display: none; position: absolute; top: 70px; right: 30px; background: var(--panel-bg); padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 3000; width: 220px; }
        #settings-panel button { width: 100%; margin-top: 10px; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; background: var(--accent-blue); color: white; }
        #offline-status { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.5; margin-top: 15px; text-align: center; }

        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 4000; align-items: center; justify-content: center; }
        #modal { background: var(--panel-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 320px; text-align: center; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
        .modal-confirm { background: #fa5252; color: white; }
        .modal-cancel { background: var(--cell-bg); color: var(--text-color); }
    </style>
</head>
<body>
    <div id="viewport" onclick="closeAllPanels()">
        <div id="universe">
            <div id="sector-alpha" class="cluster" onclick="zoomTo(0, 0, 'Alpha Sector', '#fab005')">
                <div class="cluster-core" style="background: #fab005;"></div>
                <div class="cluster-label"><span class="cluster-name">Alpha Sector</span><span id="status-Alpha-Sector" class="cluster-status"></span></div>
            </div>
            <div id="sector-crimson" class="cluster" onclick="zoomTo(-13, 18, 'Crimson Void', '#fa5252')">
                <div class="cluster-core" style="background: #fa5252;"></div>
                <div class="cluster-label"><span class="cluster-name">Crimson Void</span><span id="status-Crimson-Void" class="cluster-status"></span></div>
            </div>
            <div id="sector-azure" class="cluster" onclick="zoomTo(8, 28, 'Azure Reach', '#1c7ed6')">
                <div class="cluster-core" style="background: #1c7ed6;"></div>
                <div class="cluster-label"><span class="cluster-name">Azure Reach</span><span id="status-Azure-Reach" class="cluster-status"></span></div>
            </div>
            <div id="sector-obsidian" class="cluster" onclick="zoomTo(28, 15, 'Obsidian Gate', '#212529')">
                <div class="cluster-core" style="background: #212529;"></div>
                <div class="cluster-label"><span class="cluster-name">Obsidian Gate</span><span id="status-Obsidian-Gate" class="cluster-status"></span></div>
            </div>
            <div id="sector-emerald" class="cluster" onclick="zoomTo(25, -12, 'Emerald Nebula', '#40c057')">
                <div class="cluster-core" style="background: #40c057;"></div>
                <div class="cluster-label"><span class="cluster-name">Emerald Nebula</span><span id="status-Emerald-Nebula" class="cluster-status"></span></div>
            </div>
            <div id="sector-amber" class="cluster" onclick="zoomTo(-2, -33, 'Amber Vault', '#fd7e14')">
                <div class="cluster-core" style="background: #fd7e14;"></div>
                <div class="cluster-label"><span class="cluster-name">Amber Vault</span><span id="status-Amber-Vault" class="cluster-status"></span></div>
            </div>
            <div id="sector-indigo" class="cluster" onclick="zoomTo(-33, -20, 'Indigo Drift', '#7048e8')">
                <div class="cluster-core" style="background: #7048e8;"></div>
                <div class="cluster-label"><span class="cluster-name">Indigo Drift</span><span id="status-Indigo-Drift" class="cluster-status"></span></div>
            </div>
        </div>

        <div id="system-view" onclick="zoomOut()">
            <div class="sun-halo" id="system-halo"></div>
            <div class="central-sun" id="system-sun"></div>
            <div id="planet-container"></div>
        </div>

        <button id="back-to-galaxy" onclick="zoomOut()" style="display:none;">← Galactic Chart</button>
        <div id="help-toggle" style="position: absolute; top: 30px; right: 70px; cursor: pointer; font-size: 20px; opacity: 0.4; color: var(--text-color); z-index: 100;" onclick="event.stopPropagation(); toggleHelp()">?</div>
        <div id="settings-toggle" onclick="event.stopPropagation(); toggleSettings()">⚙</div>
    </div>

    <div id="game-overlay" onclick="closeAllPanels()">
        <div id="help-toggle-game" style="position: absolute; top: 30px; right: 70px; cursor: pointer; font-size: 20px; opacity: 0.4;" onclick="event.stopPropagation(); toggleHelp()">?</div>
        <div id="settings-toggle-game" style="position: absolute; top: 30px; right: 30px; cursor: pointer; font-size: 20px; opacity: 0.4;" onclick="event.stopPropagation(); toggleSettings()">⚙</div>
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px; margin-top: 20px;" onclick="event.stopPropagation()">
            <span class="text-btn" onclick="exitGame()">← <span class="btn-text">Exit</span></span>
            <span class="text-btn" onclick="undoMove()">↩ <span class="btn-text">Undo</span></span>
            <span class="text-btn" onclick="resetGame()">↺ <span class="btn-text">Clear</span></span>
            <span id="next-btn" class="text-btn" style="display:none;" onclick="goToNext()"><span class="btn-text">Next</span> →</span>
        </div>
        <h1 id="game-header" style="font-weight: 200; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;" onclick="event.stopPropagation()">Sector Node</h1>
        <div id="grid" onclick="event.stopPropagation()"></div>
        <div id="status" style="margin-top: 20px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; font-size: 14px;" onclick="event.stopPropagation()">Map the Sector</div>
        
        <div id="action-row" style="margin-top: 25px; display: flex; gap: 15px;" onclick="event.stopPropagation()">
            <button id="share-btn" onclick="shareResult()" style="display:none; padding: 10px 20px; border-radius: 20px; border: 1px solid var(--accent-blue); background: transparent; color: var(--accent-blue); cursor: pointer; font-weight: 600;">Share Mapping</button>
            <button id="override-btn" onclick="requestOverride()" style="padding: 10px 20px; border-radius: 20px; border: none; background: var(--accent-blue); color: white; cursor: pointer; font-weight: 600;">Ion Scan (∞)</button>
        </div>
    </div>

    <div id="help-panel" onclick="event.stopPropagation()" style="display: none; position: absolute; top: 70px; left: 30px; background: var(--panel-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 3000; width: 85%; max-width: 350px; font-size: 14px; line-height: 1.6; color: var(--text-color); overflow-y: auto; max-height: 80vh;">
        <div style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 18px; opacity: 0.3;" onclick="toggleHelp()">✕</div>
        <h3 style="margin-top: 0; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-yellow);">Operation Proxima</h3>
        <p style="font-style: italic; opacity: 0.8; font-size: 13px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px;">
            For eons, the Proxima expanse was connected by vast sub-space beacons. Then, the Great Static hit, plunging the systems into darkness. As a Pilot of the Reclamation Fleet, you must travel from system to system, identifying original coordinate patterns to stabilize the network.
        </p>
        <ul style="padding-left: 0; list-style: none; margin-bottom: 20px;">
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 20px; height: 20px; background: var(--cell-bg); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-color); font-weight: bold; border: 1px solid rgba(255,255,255,0.1);">3</div>
                <span><strong>Sensors:</strong> Clue indicating exactly how many blue active nodes are needed nearby.</span>
            </li>
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 20px; height: 20px; background: var(--accent-blue); border-radius: 4px; flex-shrink: 0;"></div>
                <span><strong>Active Node:</strong> Click a square to activate or deactivate it.</span>
            </li>
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 20px; height: 20px; background: var(--accent-yellow); border-radius: 4px; flex-shrink: 0; box-shadow: 0 0 8px var(--accent-yellow);"></div>
                <span><strong>Ion Scan:</strong> Reveals local coordinate data to assist in triangulation.</span>
            </li>
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid var(--accent-green); border-radius: 4px; flex-shrink: 0;"></div>
                <span><strong>Stable:</strong> Sensor target met. Target achieved.</span>
            </li>
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid #fa5252; border-radius: 4px; flex-shrink: 0;"></div>
                <span><strong>Over-saturated:</strong> Too many nearby nodes. Exceeds parameters.</span>
            </li>
            <li style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid #888; border-radius: 4px; flex-shrink: 0;"></div>
                <span><strong>Under-saturated:</strong> Needs more active nodes. Presence required.</span>
            </li>
        </ul>
        <p style="font-size: 12px; opacity: 0.7;">Stabilizing all nodes in a sector will clear the static and lock the trajectory, allowing for deeper exploration.</p>
    </div>

    <div id="settings-panel" onclick="event.stopPropagation()">
        <h3 style="margin-top: 0; font-weight: 300; letter-spacing: 1px;">SYSTEM SETTINGS</h3>
        <button onclick="exportData()">Export Data</button>
        <button onclick="document.getElementById('import-file').click()">Import Data</button>
        <input type="file" id="import-file" style="display: none" accept=".json" onchange="importData(event)">
        <div id="offline-status">Checking Archives...</div>
        <button onclick="toggleSettings()" style="background: var(--cell-bg); color: var(--text-color); margin-top: 20px;">Close</button>
    </div>

    <div id="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div id="modal">
            <h3 id="modal-title" style="margin-top: 0; font-weight: 300;">Confirm</h3>
            <p id="modal-body" style="font-size: 14px; opacity: 0.8; line-height: 1.4;"></p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-cancel" onclick="closeModal()">Cancel</button>
                <button id="modal-confirm-btn" class="modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        let levelManifest = [];
        let currentLevel = null;
        let state = [];
        let history = [];
        let overridePending = [];
        const levelsCache = {};
        const pTypes = ['type-rocky', 'type-water', 'type-gas', 'type-ice'];
        const sectorNames = ['Alpha Sector', 'Crimson Void', 'Azure Reach', 'Obsidian Gate', 'Emerald Nebula', 'Amber Vault', 'Indigo Drift'];

        const getCompleted = () => JSON.parse(localStorage.getItem('zen_completed') || '[]');
        const getStates = () => JSON.parse(localStorage.getItem('proxima_states') || '{}');
        const isGalaxyUnlocked = () => localStorage.getItem('proxima_galaxy_unlocked') === 'true';
        const saveState = (id, s) => {
            const all = getStates();
            all[id] = s;
            localStorage.setItem('proxima_states', JSON.stringify(all));
        };

        function toggleSettings() {
            const p = document.getElementById('settings-panel');
            const isHidden = p.style.display !== 'block';
            p.style.display = isHidden ? 'block' : 'none';
            if (isHidden) document.getElementById('help-panel').style.display = 'none';
        }

        function toggleHelp() {
            const p = document.getElementById('help-panel');
            const isHidden = p.style.display !== 'block';
            p.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                document.getElementById('settings-panel').style.display = 'none';
                localStorage.setItem('proxima_has_seen_help', 'true');
            }
        }

        function closeAllPanels() {
            document.getElementById('settings-panel').style.display = 'none';
            document.getElementById('help-panel').style.display = 'none';
        }

        function showModal(title, body, confirmText, onConfirm, hideCancel = false) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            const cb = document.getElementById('modal-confirm-btn');
            cb.innerText = confirmText;
            cb.onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('modal-cancel-btn').style.display = hideCancel ? 'none' : 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function zoomTo(x, y, name, color) {
            window.history.pushState({view: 'system', sector: name, x: x, y: y, color: color}, '', `?sector=${name.replace(/ /g, '_')}`);
            performZoomIn(x, y, name, color);
        }

        function performZoomIn(x, y, name, color) {
            console.log("Zooming to:", name);
            const completed = getCompleted();
            const galaxyUnlocked = isGalaxyUnlocked();
            
            const alphaLevels = levelManifest.filter(l => l.sector === 'Alpha Sector');
            const alphaCompleted = alphaLevels.length > 0 && alphaLevels.every(l => completed.includes(l.id));

            if (name !== 'Alpha Sector' && !galaxyUnlocked && !alphaCompleted) {
                showModal("Access Denied", "Alpha Sector stabilization required for further travel.", "Acknowledge", () => {}, true);
                return;
            } else if (alphaCompleted && !galaxyUnlocked) {
                // One-time unlock trigger if zooming into a newly unlocked sector
                localStorage.setItem('proxima_galaxy_unlocked', 'true');
            }

            const isLandscape = window.innerWidth > window.innerHeight;
            document.body.style.setProperty('--zoom-x', (isLandscape ? x*0.8 : x) + '%');
            document.body.style.setProperty('--zoom-y', (isLandscape ? y*0.5 : y) + '%');
            document.body.classList.add('zoomed');
            
            const sun = document.getElementById('system-sun');
            sun.style.background = color;
            sun.style.boxShadow = `0 0 80px ${color}aa, inset 0 0 20px rgba(255,255,255,0.5)`;
            document.getElementById('system-halo').style.background = color;
            
            const container = document.getElementById('planet-container');
            container.innerHTML = '';
            
            const states = getStates();
            const sectorLevels = levelManifest.filter(l => l.sector === name);
            const baseR = 160;

            sectorLevels.forEach((l, i) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'planet-wrapper';
                wrapper.setAttribute('data-id', l.id);
                
                const levelState = states[l.id];
                const hasProgress = levelState && levelState.flat().some(cell => cell === 1);

                if (completed.includes(l.id)) wrapper.classList.add('completed');
                else if (hasProgress) wrapper.classList.add('in-progress');

                const physSize = 12 + (l.width * 2.2); 
                const type = pTypes[i % pTypes.length];
                const angle = (i * (360 / sectorLevels.length)) * (Math.PI / 180);
                
                wrapper.style.transform = `translate(${Math.cos(angle) * baseR}px, ${Math.sin(angle) * baseR}px)`;
                wrapper.innerHTML = `
                    <div class="planet-sphere ${type}" style="width: ${physSize}px; height: ${physSize}px;"></div>
                    <div class="planet-label">${l.title}</div>
                `;
                wrapper.onclick = (e) => { e.stopPropagation(); loadLevel(l.id); };
                container.appendChild(wrapper);
            });
            document.getElementById('back-to-galaxy').style.display = 'block';
        }

        function zoomOut() {
            if (document.getElementById('game-overlay').style.display === 'flex') {
                exitGame();
            } else {
                window.history.pushState({view: 'galaxy'}, '', window.location.pathname);
                performZoomOut();
            }
        }

        function performZoomOut() {
            document.body.classList.remove('zoomed');
            document.getElementById('back-to-galaxy').style.display = 'none';
            updateSectorStatus();
        }

        function exitGame() { 
            performExitGame();
            if (currentLevel && currentLevel.sector) {
                // Find the original sector data to get the right color/coordinates
                const sectorConfigs = {
                    'Alpha Sector': { x: 0, y: 0, color: '#fab005' },
                    'Crimson Void': { x: -13, y: 18, color: '#fa5252' },
                    'Azure Reach': { x: 8, y: 28, color: '#1c7ed6' },
                    'Obsidian Gate': { x: 28, y: 15, color: '#212529' },
                    'Emerald Nebula': { x: 25, y: -12, color: '#40c057' },
                    'Amber Vault': { x: -2, y: -33, color: '#fd7e14' },
                    'Indigo Drift': { x: -33, y: -20, color: '#7048e8' }
                };
                const config = sectorConfigs[currentLevel.sector] || sectorConfigs['Alpha Sector'];
                window.history.pushState({view: 'system', sector: currentLevel.sector, x: config.x, y: config.y, color: config.color}, '', `?sector=${currentLevel.sector.replace(/ /g, '_')}`);
            }
        }

        function performExitGame() {
            document.getElementById('game-overlay').style.display = 'none'; 
        }

        async function loadLevel(id) {
            const manifestEntry = levelManifest.find(l => l.id === id);
            const s = window.history.state || {};
            window.history.pushState({
                view: 'game', 
                id: id, 
                sector: manifestEntry ? manifestEntry.sector : s.sector,
                x: s.x,
                y: s.y,
                color: s.color
            }, '', `?node=${id}`);
            performLoadLevel(id);
        }

        async function performLoadLevel(id) {
            console.log("Loading level:", id);
            let data = levelsCache[id];
            if (!data) {
                try {
                    const res = await fetch(`levels/${id}.json`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    data = await res.json();
                    data.id = id;
                    levelsCache[id] = data;
                } catch (e) {
                    console.error("Failed to load level data:", e);
                    showModal("Navigation Error", "Could not retrieve node data from the local archives.", "Acknowledge", () => { exitGame(); }, true);
                    return;
                }
            }
            currentLevel = data;

            const manifestEntry = levelManifest.find(l => l.id === id);
            if (manifestEntry) currentLevel.sector = manifestEntry.sector;
            
            const completed = getCompleted();
            if (completed.includes(id)) {
                state = JSON.parse(JSON.stringify(data.solution));
            } else {
                state = getStates()[id] || Array(data.height).fill().map(() => Array(data.width).fill(0));
            }
            history = [];
            
            document.getElementById('game-header').innerText = data.name;
            document.getElementById('game-overlay').style.display = 'flex';
            document.getElementById('share-btn').style.display = completed.includes(id) ? 'block' : 'none';
            
            const sectorLevels = levelManifest.filter(l => l.sector === currentLevel.sector);
            const hasNextInSector = true; // We loop now
            document.getElementById('next-btn').style.display = 'block';
            
            if (completed.includes(id)) {
                document.getElementById('next-btn').classList.add('glow');
                document.getElementById('override-btn').style.display = 'none';
            } else {
                document.getElementById('next-btn').classList.remove('glow');
                document.getElementById('override-btn').style.display = 'block';
            }
            
            createGrid();
            updateUI();
        }

        function createGrid() {
            const g = document.getElementById('grid');
            g.style.setProperty('--grid-width', currentLevel.width);
            g.style.gridTemplateColumns = `repeat(${currentLevel.width}, auto)`;
            g.innerHTML = '';
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    const c = document.createElement('div');
                    c.className = 'cell';
                    c.id = `cell-${x}-${y}`;
                    c.innerText = currentLevel.clues[y][x];
                    c.onclick = () => toggleCell(x, y);
                    g.appendChild(c);
                }
            }
            checkWin(true);
        }

        function toggleCell(x, y) {
            history.push(JSON.stringify(state));
            state[y][x] = state[y][x] === 0 ? 1 : 0;
            overridePending = overridePending.filter(p => p.x !== x || p.y !== y);
            saveState(currentLevel.id, state);
            
            const completed = getCompleted();
            if (!completed.includes(currentLevel.id)) {
                const p = document.querySelector(`.planet-wrapper[data-id="${currentLevel.id}"]`);
                if (p) {
                    const hasProgress = state.flat().some(cell => cell === 1);
                    p.classList.toggle('in-progress', hasProgress);
                }
            }
            updateUI();
            checkWin();
        }

        function updateUI() {
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    const c = document.getElementById(`cell-${x}-${y}`);
                    if (!c) continue;
                    c.classList.toggle('active', state[y][x] === 1);
                    const ov = overridePending.some(p => p.x === x && p.y === y);
                    c.classList.toggle('override', ov);
                }
            }
        }

        function checkWin(silent = false) {
            let solved = true;
            let active = 0;
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    if (state[y][x] === 1) active++;
                    let n = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            let nx = x + dx, ny = y + dy;
                            if (nx >= 0 && nx < currentLevel.width && ny >= 0 && ny < currentLevel.height) {
                                if (state[ny][nx] === 1) n++;
                            }
                        }
                    }
                    const c = document.getElementById(`cell-${x}-${y}`);
                    c.classList.toggle('correct', n === currentLevel.clues[y][x]);
                    c.classList.toggle('too-many', n > currentLevel.clues[y][x]);
                    if (n !== currentLevel.clues[y][x]) solved = false;
                }
            }
            if (solved && active > 0) {
                document.getElementById('status').innerText = "Trajectory Locked";
                if (!silent) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#4dabf7', '#40c057', '#fab005'] });
                    markCompleted(currentLevel.id);
                }
            } else {
                document.getElementById('status').innerText = "Map the Sector";
            }
        }

        function markCompleted(id) {
            let done = getCompleted();
            if (!done.includes(id)) {
                done.push(id);
                localStorage.setItem('zen_completed', JSON.stringify(done));
            }
            document.getElementById('share-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('next-btn').classList.add('glow');
            document.getElementById('override-btn').style.display = 'none';
            
            const p = document.querySelector(`.planet-wrapper[data-id="${id}"]`);
            if (p) {
                p.classList.remove('in-progress');
                p.classList.add('completed');
            }

            if (currentLevel && currentLevel.sector) {
                const sectorLevels = levelManifest.filter(l => l.sector === currentLevel.sector);
                if (sectorLevels.every(l => done.includes(l.id))) {
                    updateSectorStatus(); // Refresh galaxy colors
                    setTimeout(() => {
                        showModal("Sector Stabilized", `All nodes in ${currentLevel.sector} active.`, "Acknowledge", () => { exitGame(); }, true);
                    }, 500);
                }
            }
        }

        function goToNext() {
            if (!currentLevel) return;
            const sectorLevels = levelManifest.filter(l => l.sector === currentLevel.sector);
            const localIdx = sectorLevels.findIndex(l => l.id === currentLevel.id);
            if (localIdx !== -1) {
                const nextId = sectorLevels[(localIdx + 1) % sectorLevels.length].id;
                loadLevel(nextId);
            }
        }

        function undoMove() {
            if (!history.length) return;
            state = JSON.parse(history.pop());
            saveState(currentLevel.id, state);
            updateUI();
            checkWin();
        }

        function resetGame() {
            showModal("Reset Trajectory", "Purge all coordinates?", "Purge", () => {
                state = Array(currentLevel.height).fill().map(() => Array(currentLevel.width).fill(0));
                saveState(currentLevel.id, state);
                const done = getCompleted().filter(id => id !== currentLevel.id);
                localStorage.setItem('zen_completed', JSON.stringify(done));
                const p = document.querySelector(`.planet-wrapper[data-id="${currentLevel.id}"]`);
                if (p) p.classList.remove('completed', 'in-progress');
                document.getElementById('next-btn').classList.remove('glow');
                document.getElementById('override-btn').style.display = 'block';
                updateUI();
                checkWin();
            });
        }

        function requestOverride() {
            const cells = [];
            for (let y = 0; y < currentLevel.height; y++) {
                for (let x = 0; x < currentLevel.width; x++) {
                    if (state[y][x] !== currentLevel.solution[y][x]) cells.push({x, y});
                }
            }
            if (!cells.length) return;
            for (let i = 0; i < Math.min(3, cells.length); i++) {
                overridePending.push(cells.splice(Math.floor(Math.random() * cells.length), 1)[0]);
            }
            updateUI();
        }

        function shareResult() {
            const text = `Proxima 8: ${currentLevel.name}\nTrajectory Locked\n\n${window.location.href}`;
            if (navigator.share) navigator.share({ title: 'Proxima 8', text }).catch(() => {});
            else {
                navigator.clipboard.writeText(text);
                showModal("Copied", "Result copied to clipboard.", "OK", () => {}, true);
            }
        }

        function exportData() {
            const data = { completed: getCompleted(), states: getStates() };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `proxima8_save.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const d = JSON.parse(ev.target.result);
                if (d.completed) localStorage.setItem('zen_completed', JSON.stringify(d.completed));
                if (d.states) localStorage.setItem('proxima_states', JSON.stringify(d.states));
                location.reload();
            };
            reader.readAsText(file);
        }

        function onPopState(event) {
            if (!event.state) {
                performExitGame();
                performZoomOut();
            } else if (event.state.view === 'system') {
                performExitGame();
                performZoomIn(event.state.x, event.state.y, event.state.sector, event.state.color);
            } else if (event.state.view === 'game') {
                performLoadLevel(event.state.id);
            }
        }

        async function init() {
            window.addEventListener('popstate', onPopState);
            const res = await fetch('level_manifest.json');
            levelManifest = await res.json();
            updateSectorStatus();

            // Warm up the Service Worker cache with all levels from manifest
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.active) {
                        const ids = levelManifest.map(l => l.id);
                        registration.active.postMessage({ action: 'warmUp', ids });
                        
                        // Update status indicator
                        const statusEl = document.getElementById('offline-status');
                        if (statusEl) {
                            caches.open('proxima8-v21').then(cache => {
                                cache.keys().then(requests => {
                                    const cachedLevels = requests.filter(r => r.url.includes('/levels/')).length;
                                    if (cachedLevels >= levelManifest.length) statusEl.innerText = "All Sectors Archived Offline";
                                    else statusEl.innerText = `Archiving Sectors: ${Math.round((cachedLevels/levelManifest.length)*100)}%`;
                                });
                            });
                        }
                    }
                });
            }
            
            // Handle direct deep links
            const params = new URLSearchParams(window.location.search);
            const node = params.get('node');
            if (node) {
                loadLevel(node);
            } else {
                const sector = params.get('sector');
                if (sector) {
                    const name = sector.replace(/_/g, ' ');
                    const s = document.querySelector(`.cluster[id*="${name.split(' ')[0].toLowerCase()}"]`);
                    // This is limited without the exact coords in the DOM, 
                    // but for dev we'll just show the map for now.
                }
            }

            // Auto-show help if first visit
            if (!localStorage.getItem('proxima_has_seen_help')) {
                setTimeout(toggleHelp, 1000);
            }
        }

        function updateSectorStatus() {
            const completed = getCompleted();
            const states = getStates();
            const galaxyUnlocked = isGalaxyUnlocked();
            
            let alphaCompleted = false;
            const alphaLevels = levelManifest.filter(l => l.sector === 'Alpha Sector');
            alphaCompleted = alphaLevels.length > 0 && alphaLevels.every(l => completed.includes(l.id));
            
            if (alphaCompleted && !galaxyUnlocked) {
                localStorage.setItem('proxima_galaxy_unlocked', 'true');
            }

            sectorNames.forEach(name => {
                const idSafe = name.replace(' ', '-');
                const el = document.getElementById(`status-${idSafe}`);
                const firstWord = idSafe.split('-')[0].toLowerCase();
                const clusterId = `sector-${firstWord}`;
                const cluster = document.getElementById(clusterId);
                
                if (!el || !cluster) {
                    console.warn("Could not find elements for sector:", name, clusterId);
                    return;
                }

                const sectorLevels = levelManifest.filter(l => l.sector === name);
                const doneCount = sectorLevels.filter(l => completed.includes(l.id)).length;
                const startedCount = sectorLevels.filter(l => states[l.id] && states[l.id].flat().some(c => c === 1)).length;
                
                // Reset styles
                cluster.style.opacity = "1";
                cluster.style.filter = "none";
                cluster.style.pointerEvents = "all";

                if (name !== 'Alpha Sector' && !galaxyUnlocked && !alphaCompleted) {
                    cluster.style.opacity = "0.4";
                    cluster.style.filter = "grayscale(1)";
                    el.innerText = "[Locked]";
                    el.className = "cluster-status";
                } else {
                    if (doneCount === sectorLevels.length && sectorLevels.length > 0) {
                        el.innerText = "[Stable]";
                        el.className = "cluster-status status-stable";
                    } else if (doneCount > 0 || startedCount > 0) {
                        el.innerText = "[Scanning...]";
                        el.className = "cluster-status status-scanning";
                    } else {
                        el.innerText = "";
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
